# Gmail ç™¼ç¥¨è‡ªå‹•ä¸‹è¼‰å·¥å…·
# Gmail Invoice Auto-Fetcher

AI è‡ªå‹•åŒ–ç™¼ç¥¨æ•´ç†æ©Ÿå™¨äºº

---

## åŠŸèƒ½æ¦‚è¿°

### ç¬¬ä¸€éšæ®µï¼šé€£æ¥èˆ‡æƒæ âœ…
- è‡ªå‹•é€£æ¥ Gmail å¸³è™Ÿ
- æœå°‹æœªè®€çš„ç™¼ç¥¨éƒµä»¶ï¼ˆæ”¯æ´ä¸­è‹±æ–‡é—œéµå­—ï¼‰
- åˆ—å‡ºéƒµä»¶æ¨™é¡Œã€å¯„ä»¶äººã€é™„ä»¶è³‡è¨Š

### ç¬¬äºŒéšæ®µï¼šä¸‹è¼‰èˆ‡æ™ºèƒ½å‘½å âœ…
- ä¸‹è¼‰ PDF é™„ä»¶
- ä½¿ç”¨ Regex æŠ½å–ç™¼ç¥¨è³‡è¨Šï¼ˆæ—¥æœŸã€é‡‘é¡ã€çµ±ç·¨ï¼‰
- æ™ºèƒ½é‡å‘½åï¼š`YYYYMMDD_ä¾›æ‡‰å•†_é‡‘é¡.pdf`
- æ•´åˆä¾›æ‡‰å•†å­¸ç¿’æ©Ÿåˆ¶
- è‡ªå‹•æŒ‰æœˆä»½æ­¸æª”

### ç¬¬ä¸‰éšæ®µï¼šå‰ç«¯æ•´åˆï¼ˆè¦åŠƒä¸­ï¼‰
- èˆ‡ Invoice Flow å‰ç«¯ç³»çµ±æ•´åˆ
- å³æ™‚åŒæ­¥ç™¼ç¥¨è³‡æ–™

---

## å¿«é€Ÿé–‹å§‹

### 1. å®‰è£ä¾è³´

```bash
cd src/ecommerce-platform/invoice-automation
pip install -r requirements.txt
```

### 2. ç²å– Google Cloud æ†‘è­‰

#### Step 1: å»ºç«‹ Google Cloud å°ˆæ¡ˆ
1. å‰å¾€ [Google Cloud Console](https://console.cloud.google.com/)
2. é»æ“Šé ‚éƒ¨å°ˆæ¡ˆé¸æ“‡å™¨ â†’ **æ–°å¢å°ˆæ¡ˆ**
3. è¼¸å…¥å°ˆæ¡ˆåç¨±ï¼š`Invoice-Automation`
4. é»æ“Š **å»ºç«‹**

#### Step 2: å•Ÿç”¨ Gmail API
1. åœ¨ Google Cloud Console å·¦å´é¸å–®é¸æ“‡ **API å’Œæœå‹™** â†’ **è³‡æ–™åº«**
2. æœå°‹ `Gmail API`
3. é»æ“Š Gmail API â†’ **å•Ÿç”¨**

#### Step 3: è¨­å®š OAuth åŒæ„ç•«é¢
1. é€²å…¥ **API å’Œæœå‹™** â†’ **OAuth åŒæ„ç•«é¢**
2. é¸æ“‡ **å¤–éƒ¨** â†’ **å»ºç«‹**
3. å¡«å¯«å¿…è¦è³‡è¨Šï¼š
   - æ‡‰ç”¨ç¨‹å¼åç¨±ï¼š`Invoice Automation`
   - ä½¿ç”¨è€…æ”¯æ´é›»å­éƒµä»¶ï¼šä½ çš„ Gmail
   - é–‹ç™¼äººå“¡è¯çµ¡è³‡è¨Šï¼šä½ çš„ Email
4. é»æ“Š **å„²å­˜ä¸¦ç¹¼çºŒ**
5. åœ¨ã€Œç¯„åœã€é é¢ï¼Œé»æ“Š **æ–°å¢æˆ–ç§»é™¤ç¯„åœ**
6. é¸æ“‡ï¼š
   - `Gmail API` â†’ `.../auth/gmail.readonly`
   - `Gmail API` â†’ `.../auth/gmail.modify`
7. é»æ“Š **æ›´æ–°** â†’ **å„²å­˜ä¸¦ç¹¼çºŒ**
8. åœ¨ã€Œæ¸¬è©¦ä½¿ç”¨è€…ã€é é¢ï¼Œæ–°å¢ä½ çš„ Gmail åœ°å€

#### Step 4: å»ºç«‹ OAuth æ†‘è­‰
1. é€²å…¥ **API å’Œæœå‹™** â†’ **æ†‘è­‰**
2. é»æ“Š **å»ºç«‹æ†‘è­‰** â†’ **OAuth ç”¨æˆ¶ç«¯ ID**
3. æ‡‰ç”¨ç¨‹å¼é¡å‹é¸æ“‡ **æ¡Œé¢æ‡‰ç”¨ç¨‹å¼**
4. åç¨±è¼¸å…¥ï¼š`Invoice Automation Desktop`
5. é»æ“Š **å»ºç«‹**
6. é»æ“Š **ä¸‹è¼‰ JSON**
7. å°‡ä¸‹è¼‰çš„æª”æ¡ˆé‡æ–°å‘½åç‚º `client_secret.json`
8. å°‡æª”æ¡ˆæ”¾åˆ° `invoice-automation` ç›®éŒ„ä¸‹

### 3. åŸ·è¡Œç¨‹å¼

```bash
# åªæƒæï¼ˆä¸ä¸‹è¼‰ï¼‰
python gmail_invoice_fetcher.py --mode scan

# æƒæä¸¦ä¸‹è¼‰è™•ç†ï¼ˆé è¨­ï¼‰
python gmail_invoice_fetcher.py

# æŒ‡å®šæœ€å¤§éƒµä»¶æ•¸å’Œè¼¸å‡ºç›®éŒ„
python gmail_invoice_fetcher.py --max 50 --output my_invoices
```

é¦–æ¬¡åŸ·è¡Œæ™‚æœƒé–‹å•Ÿç€è¦½å™¨è¦æ±‚æˆæ¬Šï¼Œæˆæ¬Šå¾Œæœƒè‡ªå‹•å„²å­˜ tokenã€‚

---

## å‘½ä»¤åˆ—åƒæ•¸

| åƒæ•¸ | èªªæ˜ | é è¨­å€¼ |
|------|------|--------|
| `--mode` | åŸ·è¡Œæ¨¡å¼ï¼š`scan` æˆ– `download` | `download` |
| `--max` | æœ€å¤šè™•ç†çš„éƒµä»¶æ•¸é‡ | `20` |
| `--output` | è¼¸å‡ºç›®éŒ„ | `downloaded_invoices` |
| `--secret` | Google OAuth æ†‘è­‰è·¯å¾‘ | `client_secret.json` |

---

## è¼¸å‡ºç¯„ä¾‹

### ç¬¬äºŒéšæ®µè¼¸å‡º

```
============================================================
  ğŸ“§ Gmail ç™¼ç¥¨è‡ªå‹•ä¸‹è¼‰å·¥å…· - ç¬¬äºŒéšæ®µ
  Gmail Invoice Auto-Fetcher
============================================================
  åŸ·è¡Œæ™‚é–“ï¼š2025-01-15 14:30:00
  åŸ·è¡Œæ¨¡å¼ï¼šdownload
  æœ€å¤§éƒµä»¶æ•¸ï¼š20
  è¼¸å‡ºç›®éŒ„ï¼šdownloaded_invoices
============================================================

ğŸ”— æ­£åœ¨é€£æ¥ Gmail...
==================================================
âœ… æˆåŠŸé€£æ¥ï¼
ğŸ“§ ç™»å…¥å¸³è™Ÿï¼šyour.email@gmail.com
==================================================

ğŸ” æ­£åœ¨æœå°‹ç™¼ç¥¨éƒµä»¶...
ğŸ“¬ æ‰¾åˆ° 3 å°ç¬¦åˆæ¢ä»¶çš„éƒµä»¶

============================================================
ğŸ“¦ é–‹å§‹è™•ç†éƒµä»¶é™„ä»¶
============================================================

ğŸ“§ [1/3] Your PChome Invoice - Order #12345...
   ğŸ‘¤ å¯„ä»¶äººï¼šnoreply@pchome.com.tw

   ğŸ“„ è™•ç†é™„ä»¶ï¼šinvoice_12345.pdf
   âœ… å·²ä¸‹è¼‰åˆ°æš«å­˜
   ğŸ“Š æŠ½å–çµæœï¼š
      æ—¥æœŸï¼š2025-01-15
      é‡‘é¡ï¼š1500
      ä¾›æ‡‰å•†ï¼šPChome
   ğŸ“ æ–°æª”åï¼š20250115_PChome_1500.pdf
   ğŸ’¾ å·²å„²å­˜ï¼šdownloaded_invoices/2025-01/20250115_PChome_1500.pdf

ğŸ“§ [2/3] å°ç£é›»åŠ›å…¬å¸é›»å­ç™¼ç¥¨...
   ğŸ‘¤ å¯„ä»¶äººï¼šeinvoice@taipower.com.tw

   ğŸ“„ è™•ç†é™„ä»¶ï¼šé›»å­ç™¼ç¥¨_202501.pdf
   âœ… å·²ä¸‹è¼‰åˆ°æš«å­˜
   ğŸ“Š æŠ½å–çµæœï¼š
      æ—¥æœŸï¼š2025-01-10
      é‡‘é¡ï¼š2350
      ä¾›æ‡‰å•†ï¼šå°ç£é›»åŠ›è‚¡ä»½æœ‰é™å…¬å¸
   ğŸ“ æ–°æª”åï¼š20250110_å°ç£é›»åŠ›è‚¡ä»½æœ‰é™å…¬å¸_2350.pdf
   ğŸ’¾ å·²å„²å­˜ï¼šdownloaded_invoices/2025-01/20250110_å°ç£é›»åŠ›è‚¡ä»½æœ‰é™å…¬å¸_2350.pdf

============================================================
ğŸ“Š è™•ç†çµæœæ‘˜è¦
============================================================
   ğŸ“§ è™•ç†éƒµä»¶ï¼š3 å°
   ğŸ“ ç™¼ç¾é™„ä»¶ï¼š3 å€‹
   âœ… æˆåŠŸè™•ç†ï¼š3 å€‹
   â­ï¸  è·³éï¼š0 å€‹
   âŒ è™•ç†å¤±æ•—ï¼š0 å€‹
   ğŸ“ è¼¸å‡ºç›®éŒ„ï¼šC:\...\downloaded_invoices

   ğŸ·ï¸ PChome -> è¾¦å…¬ç”¨å“
   ğŸ·ï¸ å°ç£é›»åŠ›è‚¡ä»½æœ‰é™å…¬å¸ -> æ°´é›»è²»

ğŸ“ ä¾›æ‡‰å•†å­¸ç¿’çµ±è¨ˆï¼š
   å·²å­¸ç¿’ä¾›æ‡‰å•†ï¼š25 å€‹

============================================================
âœ… è™•ç†å®Œæˆï¼
============================================================
ğŸ“ ç™¼ç¥¨å·²å„²å­˜è‡³ï¼šC:\...\downloaded_invoices

ğŸ“‹ æª”æ¡ˆå‘½åæ ¼å¼ï¼šYYYYMMDD_ä¾›æ‡‰å•†_é‡‘é¡.pdf
   ä¾‹å¦‚ï¼š20240525_PChome_1500.pdf

ğŸ’¡ ä¸‹ä¸€æ­¥ï¼š
   1. æª¢æŸ¥ downloaded_invoices è³‡æ–™å¤¾ä¸­çš„ç™¼ç¥¨
   2. ç·¨è¼¯ vendor_rules_local.json èª¿æ•´åˆ†é¡
   3. ç¬¬ä¸‰éšæ®µï¼šæ•´åˆåˆ°å‰ç«¯ Invoice Flow ç³»çµ±
```

---

## å°ˆæ¡ˆçµæ§‹

```
invoice-automation/
â”œâ”€â”€ gmail_invoice_fetcher.py    # ä¸»ç¨‹å¼
â”œâ”€â”€ pdf_extractor.py            # PDF è³‡è¨ŠæŠ½å–ï¼ˆRegexï¼‰
â”œâ”€â”€ attachment_processor.py     # é™„ä»¶ä¸‹è¼‰èˆ‡è™•ç†
â”œâ”€â”€ vendor_learning.py          # ä¾›æ‡‰å•†å­¸ç¿’æ•´åˆ
â”œâ”€â”€ config.py                   # é…ç½®æª”æ¡ˆ
â”œâ”€â”€ requirements.txt            # Python ä¾è³´
â”œâ”€â”€ client_secret.json          # Google OAuth æ†‘è­‰ï¼ˆéœ€è‡ªè¡Œä¸‹è¼‰ï¼‰
â”œâ”€â”€ gmail_token.json            # Gmail Tokenï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
â”œâ”€â”€ vendor_rules_local.json     # æœ¬åœ°ä¾›æ‡‰å•†è¦å‰‡ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
â”œâ”€â”€ downloaded_invoices/        # ä¸‹è¼‰çš„ç™¼ç¥¨ï¼ˆè‡ªå‹•å»ºç«‹ï¼‰
â”‚   â”œâ”€â”€ 2025-01/
â”‚   â”‚   â”œâ”€â”€ 20250115_PChome_1500.pdf
â”‚   â”‚   â””â”€â”€ 20250110_å°é›»_2350.pdf
â”‚   â””â”€â”€ 2025-02/
â””â”€â”€ README.md
```

---

## Regex æŠ½å–é‚è¼¯

`extract_info(text)` å‡½æ•¸ä½¿ç”¨æ­£å‰‡è¡¨é”å¼æŠ½å–ï¼š

### æ—¥æœŸ
- `2024-05-20` / `2024/05/20`
- `2024å¹´5æœˆ20æ—¥`
- `æ°‘åœ‹113å¹´5æœˆ20æ—¥`
- `May 20, 2024`

### é‡‘é¡
- `NT$ 1,234` / `$1,234`
- `åˆè¨ˆ: 1,234 å…ƒ`
- `Total: NT$1,234.00`

### çµ±ç·¨
- `çµ±ä¸€ç·¨è™Ÿ: 12345678`
- ç¨ç«‹çš„ 8 ä½æ•¸å­—

### ä¾›æ‡‰å•†
- å„ªå…ˆå¾æ–‡å­—æŠ½å–å…¬å¸åç¨±
- å…¶æ¬¡ä½¿ç”¨å¯„ä»¶äººåç¨±
- æœ€å¾Œä½¿ç”¨çµ±ç·¨

---

## ä¾›æ‡‰å•†å­¸ç¿’æ©Ÿåˆ¶

### è‡ªå‹•åˆ†é¡
ç¨‹å¼æœƒè®€å– `vendorRules.json`ï¼ˆèˆ‡å‰ç«¯å…±ç”¨ï¼‰ï¼Œè‡ªå‹•å°‡å·²çŸ¥ä¾›æ‡‰å•†åˆ†é¡ï¼š
- PChome â†’ è¾¦å…¬ç”¨å“
- å°ç£é›»åŠ› â†’ æ°´é›»è²»
- Google Ads â†’ è¡ŒéŠ·è²»ç”¨

### è‡ªå‹•å­¸ç¿’
é‡åˆ°æœªçŸ¥ä¾›æ‡‰å•†æ™‚ï¼Œæœƒè‡ªå‹•æ–°å¢åˆ° `vendor_rules_local.json`ï¼Œæ¨™è¨˜ç‚ºã€Œæœªåˆ†é¡ã€ã€‚

### æ‰‹å‹•èª¿æ•´
ç·¨è¼¯ `vendor_rules_local.json` å¯èª¿æ•´åˆ†é¡ï¼š

```json
{
  "rules": {
    "æ–°ä¾›æ‡‰å•†": {
      "category": "office_supplies",
      "categoryLabel": "è¾¦å…¬ç”¨å“",
      "confidence": 0.8,
      "aliases": ["åˆ¥å1", "åˆ¥å2"],
      "notes": "æ‰‹å‹•èª¿æ•´"
    }
  }
}
```

---

## æœªä¾†æ“´å±•

### OpenAI GPT-4o-mini æ•´åˆï¼ˆé«˜ç²¾æº–åº¦ï¼‰

ç›®å‰ä½¿ç”¨ Regex çš„æº–ç¢ºç‡ç´„ 70-80%ã€‚å¦‚éœ€æ›´é«˜ç²¾æº–åº¦ï¼Œå¯å°‡ `extract_info` æ”¹ç‚ºå‘¼å« OpenAI APIï¼š

```python
# æœªä¾†ç‰ˆæœ¬
from openai import OpenAI

def extract_info_with_ai(text: str) -> dict:
    client = OpenAI()
    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {"role": "system", "content": "æŠ½å–ç™¼ç¥¨è³‡è¨Š..."},
            {"role": "user", "content": text}
        ]
    )
    return json.loads(response.choices[0].message.content)
```

é€™å¯å°‡æº–ç¢ºç‡æå‡è‡³ 99%ã€‚

---

## å¸¸è¦‹å•é¡Œ

### Q: å‡ºç¾ã€Œæ‰¾ä¸åˆ°æ†‘è­‰æª”æ¡ˆã€éŒ¯èª¤
A: è«‹ç¢ºèª `client_secret.json` å·²æ”¾åœ¨æ­£ç¢ºç›®éŒ„

### Q: ç€è¦½å™¨æˆæ¬Šå¾Œå‡ºéŒ¯
A: ç¢ºèªå·²åœ¨ OAuth åŒæ„ç•«é¢æ–°å¢æ¸¬è©¦ä½¿ç”¨è€…ï¼ˆä½ çš„ Gmailï¼‰

### Q: æœå°‹ä¸åˆ°ä»»ä½•éƒµä»¶
A: ç¢ºèªä¿¡ç®±ä¸­æœ‰æœªè®€çš„ç™¼ç¥¨éƒµä»¶ï¼Œä¸”åŒ…å«é™„ä»¶

### Q: PDF æŠ½å–è³‡è¨Šä¸æº–ç¢º
A: Regex æœ‰å…¶é™åˆ¶ï¼Œå¯æ‰‹å‹•ç·¨è¼¯ `vendor_rules_local.json` èª¿æ•´

---

## æˆæ¬Š

MIT License
